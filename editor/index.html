<!DOCTYPE html>
<html lang="en">
<head>
	<script src="./js/jquery-1.8.1.min.js"></script>
	<script src="./js/bootstrap.js"></script>
	<script src="./js/jquery.hotkeys.js"></script>
	<script src="./js/spin.min.js"></script>
  	<script src="./js/lightgl.js"></script>
  	<script src="./js/csg.js"></script>
  	
  	<script src="./js/coffee-script.js"></script>
  	<script src="./js/codemirror.js"></script>
  	<script src="./js/foldcode.js"></script>
  	<!--<script src="./codeMirror/mode/javascript/javascript.js"></script>-->
  	<script src="./codeMirror/mode/coffeescript/coffeescript.js"></script>
  	
  	<script src="./js/openjscad.js"></script>
  	<script src="./js/opencoffeescad.js"></script>
  	<script src="./js/viewer.js"></script>
  	<script src="./js/DataStore.js"></script>
  	
	<link rel="stylesheet" href="css/bootstrap.css">
	<link rel="stylesheet" href="css/font-awesome.css">
	<link rel="stylesheet" href="css/codemirror.css">
  <style>
	canvas { cursor: move; }
	.navbar .container { height: 1em; }
	.CodeMirror {
		  top: 0;
		  left: 0;
		  right: 0;
		  bottom: 0;
		  width: 95%;
		}
		
		.CodeMirror-scroll {
  overflow: auto;
  height: 750px;
  /* This is needed to prevent an IE[67] bug where the scrolled content
     is visible outside of the scrolling box. */
  position: relative;
  outline: none;
}
.fill { 
    min-height: 100%;
    height: 100%;
}
  </style>


<script>
var gProcessor=null;
var codeEditor = null;
var codeUpdated = true;

var glViewer = null;
var cadProcessor = null;
var store = null;
var projectName = "MyProject";

// Show all exceptions to the user:
//OpenJsCad.AlertUserOfUncaughtExceptions();
function onload()
{
  	/*gProcessor = new OpenJsCad.Processor(document.getElementById("viewer"),750,750);
  	gProcessor.setDebugging(true);
  	gProcessor.setJsCad(codeEditor.getValue());*/
  	
  	glViewer = new OpenCoffeeScad.Viewer(document.getElementById("viewer"),750,750);
  	cadProcessor = new OpenCoffeeScad.Processor(true, null, document.getElementById("statusBar"), glViewer);
  	cadProcessor.setJsCad(compileFormatCoffee());
  	//window.localStorage.clear();

}

var extraLibTest = ""
fromPoints = function(points) {
  var numpoints = points.length;
  if(numpoints < 3) throw new Error("CAG shape needs at least 3 points");
  var sides = [];
  var prevpoint = new CSG.Vector2D(points[numpoints-1]);
  var prevvertex = new CAG.Vertex(prevpoint);
  points.map(function(p){
    var point = new CSG.Vector2D(p);
    var vertex = new CAG.Vertex(point);
    var side = new CAG.Side(prevvertex, vertex);
    sides.push(side);
    prevvertex = vertex;  
  });
  var result = CAG.fromSides(sides);
  if(result.isSelfIntersecting())
  {
    throw new Error("Polygon is self intersecting!");
  }
  var area = result.area();
  if(Math.abs(area) < 1e-5)
  {
    throw new Error("Degenerate polygon!");
  }
  if(area < 0)
  {
    result = result.flipped();
  }
  result = result.canonicalized();
  return result;
};""

function compileFormatCoffee()
{
	/*var textblock= codeEditor.getValue();
	var lines = textblock.split('\n');
	lines.splice(0,1);
	textblock= lines.join('\n');
	console.log(textblock);*/
	
	textblock = CoffeeScript.compile(codeEditor.getValue());
	lines = textblock.split('\n');
	//console.log("Lines bla" + (lines.length-1));
	var endsplitter = lines.length-2;
	lines.splice(endsplitter,2);
	lines.splice(0,1);
	var newtext = "function main()"
	newtext += "{"
	newtext += lines.join('\n');
	newtext += "}\n";
	newtext += extraLibTest;//TODO: work on this, this is just a "namespace removing" / dependency injection test to get rid of CSG. and CAG. in the actual coffeescad projects/scripts
	//console.log(newtext);
	return newtext
}

function updateSolid()
{
	cadProcessor.setJsCad(compileFormatCoffee());
	//cadProcessor.setJsCad(codeEditor.getValue());
}
</script>
<script type="text/javascript">
function newProject()
{
	codeEditor.setValue("")
	codeEditor.clearHistory();
	updateUndoRedo();
}
function saveProject()
{
	if (projectName != "")
	{
		store.save_inBrowser(projectName, codeEditor.getValue());
		document.title = "OpenCoffeeSCad "+projectName;
	}
}

function loadProject(projectNameToLoad)
{
	if (projectNameToLoad != "" && projectNameToLoad != null)
	{
		projectName = projectNameToLoad;
		
		codeEditor.setValue(store.load_fromBrower(projectName));
    	codeEditor.clearHistory();
    	updateUndoRedo();

		document.title = "OpenCoffeeSCad "+projectName;
	}
}

function updateUndoRedo ()
{
  	var redoes = codeEditor.historySize().redo;
	var undoes = codeEditor.historySize().undo;
	//console.log("undoes"+undoes+" redoes "+redoes );
	
	if (redoes >0)
	{
		$('#redoBtn').removeClass("disabled");
	}
	else
	{
		$('#redoBtn').addClass("disabled");
	}
	if (undoes >0)
	{
		$('#undoBtn').removeClass("disabled");
	}
	else
	{
		$('#undoBtn').addClass("disabled");
	}
}

function checkCodeEditorContent()
{
	if (codeEditor.lineCount()>0)
	{
		$('#updateBtn').removeClass("disabled");
	}
}
//var foldFunc = CodeMirror.newFoldFunction(CodeMirror.braceRangeFinder);
var foldFunc = CodeMirror.newFoldFunction(CodeMirror.indentRangeFinder);

  $(document).ready(function () 
  {
	store= new OpenCoffeeScad.DataStore();
	
  	codeEditor = CodeMirror.fromTextArea(codeArea,
	{
			lineNumbers:true,
			gutter:true,
			matchBrackets:true,
			firstLineNumber:1,
			onChange: function (arg, arg2) 
			{		 
				updateUndoRedo();
				checkCodeEditorContent(); 
				codeUpdated = true;
				document.title = "OpenCoffeeSCad "+" *"+projectName;
			},
			onGutterClick: foldFunc,
			extraKeys: 
				{	"Ctrl-Q": function(cm){foldFunc(cm, cm.getCursor().line);},
					"Ctrl-P" : newProject,
					"Ctrl-S" : saveProject
				}
	});
	
  	checkCodeEditorContent();
    $("[rel=tooltip]").tooltip({placement:'bottom'});
    $(document).bind('keyup', 'shift+a', function()
    {
  		console.log("Updating solid");
  		updateSolid();
	});
	
	$(document).bind('keydown', 'F5', function()
    {
  		console.log("Updating solid");
  		updateSolid();
  		return false;
	});
	
	$("#codeArea").bind('keydown', 'F2', function()
    {
  		console.log("Saving file");
  		saveProject();
  		preventDefault();
  		return false;
	});
	
	var spinopts = 
	{
		  lines: 9, // The number of lines to draw
		  length: 3, // The length of each line
		  width: 2, // The line thickness
		  radius: 3, // The radius of the inner circle
		  corners: 1, // Corner roundness (0..1)
		  rotate: 15, // The rotation offset
		  color: '#000', // #rgb or #rrggbb
		  speed: 1.5, // Rounds per second
		  trail: 37, // Afterglow percentage
		  shadow: false, // Whether to render a shadow
		  hwaccel: false, // Whether to use hardware acceleration
		  className: 'spinner', // The CSS class to assign to the spinner
		  zIndex: 2e9, // The z-index (defaults to 2000000000)
		  top: 'auto', // Top position relative to parent in px
		  left: 'auto' // Left position relative to parent in px
	};
	var target = document.getElementById('spinner');
	var spinner = new Spinner(spinopts).spin(target);
	
	 $("#renderProgress").css('width', 100+'%');
	 
	 
	 $('#undoBtn').on('click', function (e) 
	 {
    		codeEditor.undo();
    		updateUndoRedo();
	 })
	 
	 $('#redoBtn').on('click', function (e) 
	 {
    		codeEditor.redo();
    		updateUndoRedo();	
	 })
	 $('#newFileBtn').on('click', function (e) 
	 {
    		newProject();
	 })
	 $('#saveFileBtn').on('click', function (e) 
	 {
	 		$('#fileSaveModal').modal({"backdrop":false});
	 })
	 $('#realSaveBtn').on('click', function (e) 
	 {
	 		projectName = $('#projectFileName').val(); 
	 		saveProject();
	 		$('#fileSaveModal').modal('hide');
	 })
	 
	 $('#loadFileBtn').on('click', function (e) 
	 {
	 		$('#fileLoadModal').modal({"backdrop":false});
	 })
	 
	 $('#realLoadBtn').on('click', function (e) 
	 {
	 		var saveName = $('#loadProjectFileName').val(); 
	 		loadProject(saveName);
    		$('#fileLoadModal').modal('hide');
	 })

	 $('#updateBtn').on('click', function (e)
	{
		if(codeUpdated)
		{
			codeUpdated = false;
			$('#updateBtn').addClass("disabled");
			updateSolid(); return false;
		}
	})
	
	$('#settingsBtn').on('click', function (e) 
	 {
	 	$('#settingsModal').modal({"backdrop":false});
	 })
	
	

	document.title = "OpenCoffeeSCad "+projectName;
	
	$.each(store.listSaves_fromBrowser(),  function(index, value) { 
		$('#recentFilesList').append('<li><a tabindex="-1" href="#" onclick=loadProject("'+value+'");>'+value+'</a></li>');
		$('#fileLoadModalFileList').append('<li><a tabindex="-1" href="#" onclick=loadProject("'+value+'");>'+value+'</a></li>');
	});
	
  });
</script>


<title>OpenCoffeeScad</title>  
</head>

<body onload="onload()">
	<!--<div id="spinner" class="spinner"></div>-->
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span12">
				<div class="navbar  active">
					<a class="brand"> OpenCoffeeSCad</a>
				    <div class="btn-toolbar well"  style="height: 25px; padding-top: 0px">
				    	<div class="btn-group">
				    		<a class="btn btn-small dropdown-toggle" data-toggle="dropdown" href="#" rel="tooltip" title="File"><i class="icon-file icon-large"></i>
				    			<span class="caret"></span>
				    		</a>
				    		<ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
				    			<li id ="newFileBtn"><a tabindex="-1" href="#"><i class="icon-file"></i>New</a></li>
				    			<li id ="saveFileBtn"><a tabindex="-1" href="#"><i class="icon-save"></i>Save</a></li>
				    			
				    			<li id ="saveToBtn" class="dropdown-submenu">
				    				<a tabindex="-1" href="#"><i class="icon-save"></i>Save To</a>
				    				<ul class="dropdown-menu">
                    					<li><a href="#" class="btn disabled"><i class="icon-hdd"></i> Local file (download) </a></li>
                    					<li><a href="#" class="btn disabled"><i class="icon-github"></i> Gist (versionned) </a></li>
				    				</ul>
				    			</li>
				    			<li id ="loadFileBtn"><a tabindex="-1" href="#"><i class="icon-file"></i>Load</a></li>
				    			<li id ="exportBtn" class="dropdown-submenu">
				    				<a tabindex="-1" href="#"><i class="icon-share"></i>Export</a>
				    				<ul class="dropdown-menu">
                    					<li><a href="#" class="btn disabled"><i class="icon-download disabled"></i> Stl</a></li>
                    					<li><a href="#" class="btn disabled"><i class="icon-download-alt disabled"></i> Dxf</a></li>
				    				</ul>
				    			</li>
		                        <li class="divider"></li>
		                        <ul id="recentFilesList"></ul>
		                        <li class="divider"></li>
		                        <li><a tabindex="-1" href="#"><i class="icon-bullhorn"></i>About</a></li> 
				    		</ul>
				    		<a class="btn btn-small disabled" href="#" rel="tooltip" title="Load Openscad file"><i class="icon-upload icon-large"></i></a>
							<a id="undoBtn" class="btn btn-small disabled" href="#" rel="tooltip" title="Undo (CTRL+Z)"><i class="icon-undo icon-large"></i></a>
					  		<a id="redoBtn" class="btn btn-small disabled" href="#" rel="tooltip" title="Redo (CTRL+Y)"><i class="icon-repeat icon-large"></i></a>
				    	</div>
					    <div class="btn-group">
						    <a id="updateBtn" class="btn btn-small disabled" href="#" rel="tooltip" title="Update view" ><i class="icon-refresh icon-large"></i></a>
						  	<a id="generateBtn"class="btn btn-small disabled" href="#" rel="tooltip" title="Generate STL"><i class="icon-magic icon-large"></i></a>
						  	<a id="abortBtn" class="btn hide" href="#" rel="tooltip" title="Abort"><i class="icon-remove icon-large"></i></a>

						</div>
						<div class="btn-group">
					    <a id="settingsBtn" class="btn btn-small" href="#" rel="tooltip" title="Settings"><i class="icon-cogs icon-large"></i></a>
						<a class="btn btn-small" href="#" rel="tooltip" title="Fork me on GitHub!"><i class="icon-github icon-large"></i></a>
						</div>
					</div>
				</div>
				<div class="row-fluid">
					<div id="editor" class="span6" >
						<!-- <div class="navbar-inner" style="height: 15px; padding-top: 0px">-->
						<textarea id="codeArea" class="field span12" rows="6" >		
class CubeClass
  width:20
  length:20
  height:20
  constructor: (@pos=[0,0,0], @rot=[0,0,0]) ->
    return @render()
  
  render: =>
    result = new CSG()
    cube1 =CSG.cube({center: [0, 0, @height/2],radius: [@width/2, @length/2, @height/2]})
    result = cube1
    return result.translate(@pos).rotateX(@rot[0]).rotateY(@rot[1]).rotateZ(@rot[2]) 

cubeStuff = new CubeClass()
return cubeStuff
						</textarea>
				<!--<div class="progress">
  					<div id="renderProgress" class="bar" style="width: 20%;"></div>
				</div>-->
					</div>
					<div id="viewer" class="span6"></div>
				</div>	
				<div id="spacer" style="height: 20px"></div>
				<div id="statusBar" class="well"></div>
			</div>
		</div>
	</div>
	
	<div id="fileSaveModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	    <div class="modal-header">
	      <h3 id="myModalLabel">Save File As</h3>
	    </div>
	    <div class="modal-body">
	    	Save as 
	     <input type="text" name="some_name" value="MyProject" id="projectFileName"/><br>
	     The current code will be saved in the browser using local storage
	    </div>
	    <div class="modal-footer">
	      <button class="btn" data-dismiss="modal">Close</button>
	      <button id="realSaveBtn" class="btn btn-primary">Save</button>
	    </div>
  	</div>
  	
  	<div id="fileLoadModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	    <div class="modal-header">
	      <h3 id="myModalLabel">Load File</h3>
	    </div>
	    Files:
	    <div class="modal-body">
	    	<ul id="fileLoadModalFileList"></ul>
	     <input type="text" name="some_name" value="MyProject" id="loadProjectFileName"/><br>
	    </div>
	    <div class="modal-footer">
	      <button class="btn" data-dismiss="modal">Close</button>
	      <button id="realLoadBtn" class="btn btn-primary">Load</button>
	    </div>
  	</div>
  	
  	<div id="settingsModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	    <div class="modal-header">
	      <h3 id="myModalLabel">Settings</h3>
	    </div>
	    <div class="modal-body">
			<h4>Code editor</h4>
				Start line : 1
				Theme : 
			<h4>Stl Export</h4>
	    </div>
	    <div class="modal-footer">
	      <button class="btn" data-dismiss="modal">Close</button>
	      <button id="realLoadBtn" class="btn btn-primary">Load</button>
	    </div>
  	</div>
	
</body>

</html>
